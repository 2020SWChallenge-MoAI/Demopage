#!/bin/bash

function kill_port() {
    who=$1
    port=$2

    pid=$(netstat -tnlp 2>/dev/null | grep ":$port" | awk -F'LISTEN *|/' '/^(tcp|udp)/{print $2}')
    if [ -n "$pid" ]
    then
        kill $pid
        echo $who : Process $pid killed
    fi
    unset pid
}

function kill_all() {
    kill_port "Demo Webserver" "9000"
    kill_port "Keyword Extraction Server" "9001"
    kill_port "NER Server" "9002"
    kill_port "Main Sentence Server" "9003"
}

trap "kill_all; exit" SIGHUP SIGINT SIGTERM

source activate demo-webserver

# Execute Keyword Extraction Module
kill_port "Keyword Extraction Server" "9001"
python modules/keyword-extraction-server.py&

# Execute NER Module
kill_port "NER Server" "9002"
python modules/ner-server.py&

# Execute Main Sentence Extraction Module
kill_port "Main Sentence Extraction Server" "9003"
python modules/main-sentence-extraction-server.py&

# Execute Demo Webserver
kill_port "Demo Webserver" "9000"
node server.js